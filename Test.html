<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <title>ÙˆØ£Ø®Ø± Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª - Focus Surah Quiz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: "Cairo", Arial, sans-serif;
            direction: rtl;
            text-align: right;
            padding: 20px;
            background-color: #f8f9fa;
        }

        h2 {
            text-align: center;
        }

        .result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .1);
            margin-top: 15px;
        }

        button {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            background: #2e86de;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #1b4f72;
        }

        .surah-box {
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 8px;
        }

        #surahSelect {
            width: 100%;
            border: none;
            outline: none;
            font-size: 15px;
            font-family: "Cairo", Arial;
        }

        #surahSelect option {
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 4px;
        }

        #surahSelect option:checked {
            background-color: #2e86de;
            color: white;
        }

        select, input {
            margin-top: 5px;
            margin-bottom: 10px;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 15px;
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            h2 {
                font-size: 20px;
                text-align: center;
            }

            button {
                width: 100%;
                margin-top: 10px;
                font-size: 16px;
            }

            .surah-box {
                max-height: 160px;
            }
        }

        .quiz-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background-color: #2e86de;
            color: white;
            font-size: 15px;
            cursor: pointer;
            transition: 0.3s;
        }

        .quiz-btn:hover {
            background-color: #1b4f72;
        }

        #answer p {
            background: #f1f3f6;
            padding: 8px 10px;
            border-radius: 6px;
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <h2>ÙˆØ£Ø®Ø± Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª - Focus Surah Quiz</h2>

    <!-- Multi-surah filter -->
    <label>Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ± Ù„Ù„Ø¨Ø­Ø«:</label>
    <button type="button" onclick="toggleSurahList()">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ± ğŸ“œ</button>
    <div id="surahBox" class="surah-box" style="display:none;">
        <select id="surahSelect" multiple></select>
    </div>

    <br><br>

    <!-- Focus surah filter -->
    <label>Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù„Ù„Ø­ÙØ¸):</label>
    <select id="focusSurah">
        <option value="">-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ --</option>
    </select>

    <br><br>

    <!-- Word limits -->
    <label>Ø£Ù‚Ù„ Ø¹Ø¯Ø¯ ÙƒÙ„Ù…Ø§Øª:</label>
    <input type="number" id="minWords" value="3">

    <label>Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ ÙƒÙ„Ù…Ø§Øª:</label>
    <input type="number" id="maxWords" value="10">

    <br><br>

    <button onclick="searchOccurrences()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒÙˆÙŠØ²</button>

    <div id="quizBox" class="result" style="display:none; text-align:center;">
        <p id="phrase" style="font-size:18px; font-weight:bold; margin-bottom:10px;"></p>
        <p id="count" style="color:#555; margin-bottom:20px;"></p>

        <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
            <button onclick="showAnswer()" class="quiz-btn">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¬ÙˆØ§Ø¨</button>
            <button onclick="showSurahNames()" class="quiz-btn">Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø³ÙˆØ± ÙÙ‚Ø· ğŸ“œ</button>
        </div>

        <div id="answer" style="display:none; margin-top:15px; text-align:right;"></div>

        <button onclick="nextQuestion()" class="quiz-btn" style="margin-top:20px;">Ø§Ù„ØªØ§Ù„ÙŠ â­ï¸</button>
    </div>

    <!-- Quran data -->
    <script src="quranData.js"></script>

    <script>
        // ===== Defaults =====
        const defaultSurahs = [
            "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "ÙŠÙˆÙ†Ø³", "Ù‡ÙˆØ¯"
        ];

        // ===== UI Functions =====
        function toggleSurahList() {
            const box = document.getElementById("surahBox");
            box.style.display = box.style.display === "none" ? "block" : "none";
        }

        // ===== Variables =====
        let finalResults = [];
        let quizIndex = 0;

        // ===== Populate surahs =====
        function populateSurahSelect() {
            const surahSelect = document.getElementById("surahSelect");
            const surahSet = new Set();

            quranData.forEach(a => surahSet.add(a.sura_name_ar.trim()));

            Array.from(surahSet).forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;

                // Auto-select defaults
                if (defaultSurahs.includes(name)) opt.selected = true;

                surahSelect.appendChild(opt);
            });

            // Populate focus surah
            const focusSelect = document.getElementById("focusSurah");
            Array.from(surahSet).forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                focusSelect.appendChild(opt);
            });
        }

        // ===== Search occurrences =====
        function searchOccurrences() {
            const selectedSurahs = Array.from(document.getElementById("surahSelect").selectedOptions).map(o => o.value);
            const focusSurah = document.getElementById("focusSurah").value.trim();
            const minWords = parseInt(document.getElementById("minWords").value);
            const maxWords = parseInt(document.getElementById("maxWords").value);

            // Filter data by selected surahs
            let filteredData = [];
            if (selectedSurahs.length > 0) {
                selectedSurahs.forEach(surah => {
                    quranData.forEach(a => {
                        if (a.sura_name_ar.trim() === surah) filteredData.push(a);
                    });
                });
            } else filteredData = quranData;

            // Core logic: seenPhrases + resultsMap
            const resultsMap = new Map();
            const seenPhrases = new Map();

            filteredData.forEach(aya => {
                const cleanedText = aya.aya_text.trim();
                const words = cleanedText.split(/\s+/);

                for (let len = minWords; len <= maxWords; len++) {
                    for (let i = 0; i <= words.length - len; i++) {
                        const phrase = words.slice(i, i + len).join(" ").trim();
                        const isAtStart = i === 0;
                        const isAtEnd = i + len === words.length;

                        if (!isAtStart && !isAtEnd) continue;
                        if (phrase.length === 1) continue;

                        if (!seenPhrases.has(phrase)) {
                            seenPhrases.set(phrase, [{
                                surah: aya.sura_name_ar,
                                aya_no: aya.aya_no,
                                text: cleanedText,
                                atStart: isAtStart,
                                atEnd: isAtEnd
                            }]);
                        } else {
                            if (!resultsMap.has(phrase)) {
                                resultsMap.set(phrase, [...seenPhrases.get(phrase)]);
                            }
                            resultsMap.get(phrase).push({
                                surah: aya.sura_name_ar,
                                aya_no: aya.aya_no,
                                text: cleanedText,
                                atStart: isAtStart,
                                atEnd: isAtEnd
                            });
                        }
                    }
                }
            });

            // Build finalResults
            finalResults = [];
            resultsMap.forEach((occ, phrase) => {
                if (occ.length > 1 && occ.some(o => o.atStart || o.atEnd)) {
                    finalResults.push({
                        phrase,
                        count: occ.length,
                        occurrences: occ
                    });
                }
            });

            // Remove smaller phrases inside larger ones
            finalResults = finalResults.filter((res, i, arr) => {
                return !arr.some(other =>
                    other.phrase !== res.phrase &&
                    other.phrase.includes(res.phrase) &&
                    other.count === res.count
                );
            });

            // Apply focus surah filter
            if (focusSurah) {
                finalResults = finalResults.filter(res =>
                    res.occurrences.some(o => o.surah === focusSurah)
                );
            }

            // Shuffle
            finalResults.sort(() => Math.random() - 0.5);

            quizIndex = 0;
            if (finalResults.length === 0) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬");
                return;
            }

            document.getElementById("quizBox").style.display = "block";
            showQuestion();
        }

        // ===== Quiz functions =====
        function showQuestion() {
            const q = finalResults[quizIndex];
            document.getElementById("phrase").innerHTML = `<strong>Ø§Ù„Ø¹Ø¨Ø§Ø±Ø©:</strong> ${q.phrase}`;
            document.getElementById("count").innerHTML = `<strong>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø±:</strong> ${q.count}`;
            document.getElementById("answer").style.display = "none";
            document.getElementById("answer").innerHTML = "";
        }

        function showAnswer() {
            const q = finalResults[quizIndex];
            const div = document.getElementById("answer");
            const focusSurah = document.getElementById("focusSurah").value.trim();
            div.innerHTML = "";

            q.occurrences.forEach(o => {
                const p = document.createElement("p");
                if (o.surah === focusSurah) p.style.background = "#fffae6";
                p.textContent = `ğŸ“– ${o.surah} â€” Ø§Ù„Ø¢ÙŠØ© ${o.aya_no} â†’ ${o.text}`;
                div.appendChild(p);
            });

            div.style.display = "block";
        }

        function showSurahNames() {
            const q = finalResults[quizIndex];
            const div = document.getElementById("answer");
            const set = new Set();
            q.occurrences.forEach(o => set.add(o.surah));
            div.innerHTML = `<strong>Ø§Ù„Ø³ÙˆØ±:</strong> ${Array.from(set).join(" â€” ")}`;
            div.style.display = "block";
        }

        function nextQuestion() {
            quizIndex++;
            if (quizIndex >= finalResults.length) {
                alert("ğŸŒ¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙƒÙˆÙŠØ²");
                quizIndex = 0;
            }
            showQuestion();
        }

        // ===== Initialize =====
        populateSurahSelect();
    </script>
</body>

</html>
